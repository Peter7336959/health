<!DOCTYPE html>
<html lang="zh-TW">
<head>
<style type="text/css">
.inline {
  background-color: #f7f7f7;
  border:solid 1px #B0B0B0;
}
.error {
	font-weight: bold;
	color: #FF0000;
}
.warning {
	font-weight: bold;
}
.message {
	font-style: italic;
}
.source, .output, .warning, .error, .message {
	padding: 0 1em;
  border:solid 1px #F7F7F7;
}
.source {
  background-color: #f5f5f5;
}
.left {
  text-align: left;
}
.right {
  text-align: right;
}
.center {
  text-align: center;
}
.hl.num {
  color: #AF0F91;
}
.hl.sng {
  color: #317ECC;
}
.hl.com {
  color: #AD95AF;
  font-style: italic;
}
.hl.opt {
  color: #000000;
}
.hl.def {
  color: #585858;
}
.hl.kwa {
  color: #295F94;
  font-weight: bold;
}
.hl.kwb {
  color: #B05A65;
}
.hl.kwc {
  color: #55aa55;
}
.hl.kwd {
  color: #BC5A65;
  font-weight: bold;
}
</style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>115å¹´åº¦ å¥æª¢è­·ç†ç­ æ¨¡æ“¬è€ƒé¡Œæ™ºæ…§è¤‡ç¿’ç³»çµ±</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Chosen Palette: Warm Neutrals & Medical Teal -->
    <!-- Primary Background: #fcfbf9 (Warm White) -->
    <!-- Primary Text: #2d3748 (Dark Slate) -->
    <!-- Accent Color: #0d9488 (Teal-600) -->
    <!-- Secondary Accent: #f59e0b (Amber-500) -->

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #fcfbf9;
            color: #2d3748;
        }

        /* Chart Container Styling - MANDATORY for responsiveness */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px; /* Max width to prevent stretching */
            margin-left: auto;
            margin-right: auto;
            height: 300px; /* Base height */
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e0; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0; 
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .option-btn {
            transition: all 0.2s ease;
        }
        .option-btn:active {
            transform: scale(0.98);
        }
    </style>
    
    <!-- Application Structure Plan: 
         1. Header: Branding and Navigation.
         2. View Container: Dynamic switching between:
            - Dashboard: Overview of exam topics (Chart.js) and file upload.
            - KnowledgeBank: Searchable list of all questions for study.
            - QuizMode: Card-based interface for taking the test.
            - Results: Post-game analytics (Chart.js) and error review.
         3. Logic: Centralized 'appState' object manages questions, scores, and navigation. 
    -->

    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="flex flex-col min-h-screen">

    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center gap-2">
                        <span class="text-2xl text-teal-600">âš•ï¸</span>
                        <h1 class="text-xl font-bold text-gray-800 tracking-tight">å¥æª¢è­·ç†ç­ <span class="text-teal-600 font-light">æ™ºæ…§è¤‡ç¿’</span></h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="navTo('dashboard')" class="text-gray-600 hover:text-teal-600 px-3 py-2 rounded-md text-sm font-medium transition-colors">å„€è¡¨æ¿</button>
                    <button onclick="navTo('bank')" class="text-gray-600 hover:text-teal-600 px-3 py-2 rounded-md text-sm font-medium transition-colors">é¡Œåº«ç€è¦½</button>
                    <button onclick="startQuiz()" class="bg-teal-600 text-white hover:bg-teal-700 px-4 py-2 rounded-md text-sm font-medium shadow-sm transition-colors">é–‹å§‹æ¸¬é©—æˆ–æ›é¡Œ</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8">

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="fade-in block">
            <div class="text-center mb-12">
                <h2 class="text-3xl font-bold text-gray-900 mb-4">æ­¡è¿ä½¿ç”¨æ¨¡æ“¬è€ƒé¡Œåˆ†æç³»çµ±</h2>
                <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                    æœ¬ç³»çµ±æä¾›é¡Œç›®åˆ†æã€éš¨æ©Ÿæ¸¬é©—èˆ‡éŒ¯é¡Œæª¢è¨ã€‚ç›®å‰å·²é è¼‰ <span id="total-questions-count" class="font-bold text-teal-600">--</span> é¡Œè³‡æ–™ã€‚
                    <br>æ‚¨å¯ä»¥ç›´æ¥é–‹å§‹ç·´ç¿’ï¼Œæˆ–<span class="text-teal-600 font-bold">ä¸Šå‚³å®Œæ•´ CSV æª”</span>ä»¥è¼‰å…¥æ‰€æœ‰é¡Œç›®ã€‚
                </p>
                
                <!-- File Upload -->
                <div class="mt-8 flex justify-center">
                    <label class="relative cursor-pointer bg-white rounded-md font-medium text-teal-600 hover:text-teal-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-teal-500 border border-teal-200 px-6 py-4 shadow-sm hover:shadow-md transition-all">
                        <span>ğŸ“¥ ä¸Šå‚³å®Œæ•´ CSV è€ƒé¡Œæª”</span>
                        <input id="csv-upload" type="file" accept=".csv" class="sr-only" onchange="handleFileUpload(this)">
                    </label>
                </div>
                <p id="upload-status" class="mt-2 text-sm text-gray-500"></p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Analysis Card 1: Topic Distribution -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                    <div class="mb-4">
                        <h3 class="text-lg font-bold text-gray-800">è€ƒé¡Œé¡å‹åˆ†æ</h3>
                        <p class="text-sm text-gray-500">åŸºæ–¼é¡Œç›®é—œéµå­—è‡ªå‹•åˆ†é¡</p>
                    </div>
                    <!-- Chart Container -->
                    <div class="chart-container">
                        <canvas id="topicChart"></canvas>
                    </div>
                    <div class="mt-4 text-sm text-gray-600 text-center">
                        ç³»çµ±è‡ªå‹•åµæ¸¬é¡Œç›®ä¸­çš„é—œéµå­—ï¼ˆå¦‚ï¼šæ³•è¦ã€å™ªéŸ³ã€åŒ–å­¸ã€ä»£è¬ç­‰ï¼‰é€²è¡Œåˆ†é¡çµ±è¨ˆã€‚
                    </div>
                </div>

                <!-- Analysis Card 2: System Stats -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 flex flex-col justify-center">
                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-gray-800">å­¸ç¿’æ•¸æ“šæ¦‚è¦½</h3>
                        <p class="text-sm text-gray-500">ç›®å‰çš„é¡Œåº«ç‹€æ…‹</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-teal-50 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold text-teal-700" id="stat-total">0</div>
                            <div class="text-xs text-teal-600 uppercase tracking-wide font-semibold">ç¸½é¡Œæ•¸</div>
                        </div>
                        <div class="bg-amber-50 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold text-amber-700" id="stat-avg-len">0</div>
                            <div class="text-xs text-amber-600 uppercase tracking-wide font-semibold">å¹³å‡é¡Œç›®é•·åº¦ (å­—)</div>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4 text-center col-span-2">
                            <div class="text-3xl font-bold text-blue-700">æº–å‚™å°±ç·’</div>
                            <div class="text-xs text-blue-600 uppercase tracking-wide font-semibold">ç³»çµ±ç‹€æ…‹</div>
                        </div>
                    </div>
                    <div class="mt-6 text-center">
                         <button onclick="startQuiz()" class="w-full bg-teal-600 text-white py-3 rounded-lg shadow hover:bg-teal-700 transition-colors font-bold">ç«‹å³é–‹å§‹éš¨æ©Ÿæ¸¬é©—</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: KNOWLEDGE BANK -->
        <div id="view-bank" class="fade-in hidden">
            <div class="mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">é¡Œåº«ç€è¦½æ¨¡å¼</h2>
                    <p class="text-gray-500">æœå°‹é—œéµå­—ä»¥è¤‡ç¿’ç‰¹å®šè§€å¿µ (é¡¯ç¤ºå…¨éƒ¨)</p>
                </div>
                <div class="relative w-full md:w-96">
                    <input type="text" id="search-input" placeholder="æœå°‹é¡Œç›®æˆ–é¸é …å…§å®¹..." class="w-full border border-gray-300 rounded-lg pl-4 pr-10 py-2 focus:ring-2 focus:ring-teal-500 focus:border-transparent outline-none" oninput="renderBank()">
                    <span class="absolute right-3 top-2.5 text-gray-400">ğŸ”</span>
                </div>
            </div>

            <div id="bank-list" class="space-y-4">
                <!-- Questions injected here -->
            </div>
             <p id="bank-count" class="text-center text-sm text-gray-400 mt-4"></p>
        </div>

        <!-- VIEW: QUIZ MODE -->
        <div id="view-quiz" class="fade-in hidden max-w-3xl mx-auto">
            <!-- Progress Bar -->
            <div class="mb-6">
                <div class="flex justify-between text-sm font-medium text-gray-500 mb-2">
                    <span>é€²åº¦</span>
                    <span id="quiz-progress-text">1 / 10</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="quiz-progress-bar" class="bg-teal-600 h-2.5 rounded-full transition-all duration-300" style="width: 10%"></div>
                </div>
            </div>

            <!-- Question Card -->
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
                <div class="p-8 bg-gray-50 border-b border-gray-100 flex justify-between items-start">
                    <div>
                        <span class="inline-block px-2 py-1 bg-teal-100 text-teal-800 text-xs font-bold rounded mb-2">å–®é¸é¡Œ</span>
                        <h3 id="quiz-question" class="text-xl md:text-2xl font-bold text-gray-800 leading-relaxed">
                            é¡Œç›®è¼‰å…¥ä¸­...
                        </h3>
                    </div>
                    <div class="text-gray-400 font-mono text-sm" id="quiz-id">#01</div>
                </div>

                <div class="p-8">
                    <div id="quiz-options" class="grid grid-cols-1 gap-4">
                        <!-- Options injected here -->
                    </div>
                </div>

                <!-- Feedback Area -->
                <div id="quiz-feedback" class="hidden bg-gray-50 p-6 border-t border-gray-200">
                    <div id="feedback-content" class="mb-4 text-lg font-medium"></div>
                    <button id="btn-next" onclick="nextQuestion()" class="w-full bg-gray-800 text-white py-3 rounded-lg hover:bg-gray-700 transition-colors font-bold shadow-lg">ä¸‹ä¸€é¡Œ â†’</button>
                    <button id="btn-finish" onclick="finishQuiz()" class="hidden w-full bg-teal-600 text-white py-3 rounded-lg hover:bg-teal-700 transition-colors font-bold shadow-lg">æŸ¥çœ‹çµæœ</button>
                </div>
            </div>
        </div>

        <!-- VIEW: RESULTS -->
        <div id="view-results" class="fade-in hidden">
            <div class="text-center mb-10">
                <h2 class="text-3xl font-bold text-gray-900">æ¸¬é©—çµæœåˆ†æ</h2>
                <p class="text-gray-500 mt-2">æœ¬æ¬¡ç·´ç¿’çš„è©³ç´°æ•¸æ“š</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
                <!-- Score Card -->
                <div class="bg-white rounded-xl shadow-lg p-6 border-t-4 border-teal-500 text-center flex flex-col justify-center items-center">
                    <div class="text-gray-500 font-medium uppercase tracking-wider text-sm mb-2">æœ€çµ‚å¾—åˆ†</div>
                    <div class="text-5xl font-extrabold text-teal-600 mb-2" id="result-score">0</div>
                    <div class="text-gray-400 text-sm">ç­”å°é¡Œæ•¸ / ç¸½é¡Œæ•¸</div>
                </div>

                <!-- Accuracy Chart -->
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 md:col-span-2">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">ç­”é¡Œè¡¨ç¾åˆ†ä½ˆ</h3>
                    <div class="chart-container h-64">
                        <canvas id="resultsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Wrong Answers Review -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                <div class="p-6 bg-red-50 border-b border-red-100">
                    <h3 class="text-xl font-bold text-red-800 flex items-center gap-2">
                        <span>âš ï¸</span> éŒ¯èª¤é¡Œé …æª¢è¨
                    </h3>
                </div>
                <div id="wrong-answers-list" class="divide-y divide-gray-100">
                    <!-- Wrong items injected here -->
                    <div class="p-8 text-center text-gray-500">
                        å¤ªæ£’äº†ï¼æœ¬æ¬¡æ¸¬é©—æ²’æœ‰éŒ¯èª¤é¡Œç›®ã€‚ğŸ‰
                    </div>
                </div>
            </div>

            <div class="mt-8 text-center space-x-4">
                <button onclick="navTo('dashboard')" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium transition-colors">è¿”å›å„€è¡¨æ¿</button>
                <button onclick="startQuiz()" class="px-6 py-3 bg-teal-600 text-white rounded-lg hover:bg-teal-700 font-medium shadow-md transition-colors">å†æ¬¡æ¸¬é©—</button>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-auto">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <p class="text-center text-gray-400 text-sm">
                115å¹´åº¦å¥æª¢è­·ç†ç­æ¨¡æ“¬è€ƒé¡Œæ™ºæ…§è¤‡ç¿’ç³»çµ± | Designed for Learning
            </p>
        </div>
    </footer>

    <!-- Visualization & Content Choices:
         1. Topic Chart (Doughnut): Goal is 'Inform/Organize'. Used to categorize unstructured quiz data into meaningful themes.
         2. Results Chart (Bar): Goal is 'Inform/Compare'. Visualizes Correct vs Incorrect.
         3. Question Cards: Goal is 'Inform/Interact'.
         4. Robust CSV Parser: Handles newlines within quotes.
         5. NO SVG/Mermaid used.
    -->

    <script>
        // --- Data Handling ---
        
        // Extended embedded data from the source snippets
        const initialCSV = `é …æ¬¡,é¡Œç›®,é¸é …,æ­£ç¢ºç­”æ¡ˆ
1,é©ç•¶é…å·¥(Proper Placement)å¯ä»¥å¢åŠ ç”Ÿç”¢åŠ›ï¼Œä¸‹åˆ—æ•˜è¿°ä½•è€…ç‚ºéï¼Ÿ,"(1)é…å·¥ä¾æ“šåƒ…ç‚ºé«”æ ¼æª¢æŸ¥çµæœ (2)éœ€è€ƒé‡ä½œæ¥­ç’°å¢ƒèˆ‡ç¨®é¡ (3)è€ƒé‡å‹å·¥æ€§åˆ¥ã€å¹´é½¡ã€èº«å¿ƒç‹€æ…‹ (4)è’é›†å¥åº·è³‡è¨ŠåŒ…æ‹¬ç—…å²èˆ‡ç”Ÿæ´»ç¿’æ…£",1
2,åœ‹éš›ç³–å°¿ç—…å­¸æœƒ(IDF)èªå®šä»£è¬ç—‡å€™ç¾¤çš„å±éšªå› å­ä»¥ä½•è€…ç‚ºæ ¸å¿ƒï¼Ÿ,"(1)è¡€å£“ç•°å¸¸ (2)è¡€è„‚è‚ªç•°å¸¸ (3)ç©ºè…¹è¡€ç³–ç•°å¸¸ (4)ä¸­å¤®å‹è‚¥èƒ–",4
3,ä¾æ“šå‹å·¥å¥åº·ä¿è­·è¦å‰‡ï¼Œæœ‰é—œé‡é‡‘å±¬ç‰¹æ®Šå¥æª¢ç”Ÿç‰©åµæ¸¬ï¼Œä½•è€…éŒ¯èª¤ï¼Ÿ,"(1)ä¹™åŸºæ±ï¼šå°¿ä¸­æ± (2)é³ï¼šå°¿ä¸­é³ (3)å››çƒ·åŸºé‰›ï¼šå°¿ä¸­é‰› (4)é‰»é…¸ï¼šå°¿ä¸­é‰»","(1,3)"
4,ä¸‹åˆ—ä½•é …ç›®éç‚ºä¸€èˆ¬é«”æ ¼æª¢æŸ¥é …ç›®ï¼Ÿ,"(1)ä½å¯†åº¦è„‚è›‹ç™½è†½å›ºé†‡ (2)èƒ¸éƒ¨ X å…‰ (3)é«˜å¯†åº¦è„‚è›‹ç™½è†½å›ºé†‡ (4)å°¿è›‹ç™½åŠå°¿æ½›è¡€",1
5,æ¸…ç†æº«æ³‰æ§½ã€æ± ã€ç®¡çš„å‹å·¥å¯èƒ½æš´éœ²åˆ°ä¸‹åˆ—ä½•ç¨®æ°£é«”ï¼Ÿ,"(1)äºŒæ°§åŒ–ç¡« (2)ç¡«åŒ–æ°« (3)ä¸€æ°§åŒ–ç¢³ (4)æ°¯åŒ–æ°«",2
6,è½åŠ›æª¢æŸ¥æ‡‰å¾å“ªä¸€è€³é–‹å§‹æª¢æŸ¥ï¼Ÿ,"(1)éš¨æ©Ÿ (2)ç¶“æ¸¬è©¦è½åŠ›è¼ƒå„ªè€³ (3)å³è€³ (4)ç¶“æ¸¬è©¦è½åŠ›è¼ƒåŠ£è€³",2
7,ã€Œåå¹´å¿ƒè¡€ç®¡é¢¨éšªã€ç‚ºä½ï¼Œä½†ã€Œå·¥ä½œè² è·ã€ç‚ºé«˜ï¼Œå¦‚ä½•è¦åŠƒæªæ–½ï¼Ÿ,"(1)ç¬¬ä¸€ç´šç®¡ç† (2)ç¬¬äºŒç´šç®¡ç† (3)ç¬¬ä¸‰ç´šç®¡ç† (4)ç¬¬å››ç´šç®¡ç†",1
60,æˆ‘åœ‹è·æ¥­ç—…èªå®šåŸºæº–äº”é …è¦ä»¶ä¸­ï¼Œä¸‹åˆ—ä½•è€…æ­£ç¢ºï¼Ÿ,"(1)ä¸»å®¢è§€ç–¾ç—…è­‰æ“š (2)çµæœå…ˆæ–¼åŸå›  (3)æš´éœ²è­‰æ“šå¯ç„¡ (4)æµè¡Œç—…å­¸è­‰æ“š","(1,4)"
61,é‰›ä½œæ¥­å‹å·¥è¡€ä¸­é‰›éé«˜ã€è²§è¡€æ™‚ï¼Œä½•è€…é…å·¥æªæ–½æœ€æ­£ç¢ºï¼Ÿ,"(1)æ¡å–å±å®³æ§åˆ¶åŠç®¡ç†æªæ–½ (2)åˆ—ç‚ºå·¥ä½œé™åˆ¶ (3)ä¸å¾—åƒ±ç”¨ (4)å„ªå…ˆè¯åˆç™‚æ³•",1
62,é•·æœŸæš´éœ²é‰›ç‡»ç…™æœƒç½¹æ‚£ä¸‹åˆ—ä½•ç¨®è·æ¥­ç—…ï¼Ÿ,"(1)è…•é“ç—‡å€™ç¾¤ (2)è…•å‚ç—‡ (3)æ¿æ©ŸæŒ‡ (4)å¤šç™¼æ€§ç¥ç¶“ç‚ç—‡ç‹€",4
63,ä¸‹åˆ—æœ‰é—œé†«ç™‚ç›¸é—œæ³•è¦ä¹‹æ•˜è¿°ï¼Œä½•è€…æœ‰èª¤ï¼Ÿ,"(1)ç—…æ­·å¢åˆªè™•éœ€ç°½ç«  (2)ä¾å®¶å±¬å£è¿°é–‹æ­»äº¡è­‰ (3)éç—…æ­»æ‡‰å ±ç›¸é©— (4)ä¸å¾—æ´©å¯†",2
64,æ€§åˆ¥ã€æ•™è‚²ç¨‹åº¦ã€è·æ¥­ç­‰å±¬ä¸‹åˆ—ä½•è®Šé …ï¼Ÿ,"(1)é¡åˆ¥è®Šé … (2)åºä½è®Šé … (3)æè¿°æ€§è®Šé … (4)é€£çºŒè®Šé …",1
65,ç®¡æ§å‹å·¥å¥æª¢ä¹‹å•è¨ºèˆ‡ç†å­¸æª¢æŸ¥å“è³ªï¼Œä½•è€…æœ‰èª¤ï¼Ÿ,"(1)å¯©è¦–æš´éœ²è³‡æ–™ (2)ç†å­¸æª¢æŸ¥ä»”ç´°è©•ä¼° (3)è©¢å•ç—…å² (4)æœ‰æ•ˆå¿«é€ŸåŸ·è¡Œ",4
66,ä¸‹åˆ—æœ‰é—œå‹å·¥ç‰¹æ®Šå¥åº·æª¢æŸ¥ä¹‹æ•˜è¿°ï¼Œä½•è€…æœ‰èª¤ï¼Ÿ,"(1)é†«å¸«å¿…å…·è·é†«å°ˆç§‘è³‡æ ¼ (2)èªå¯æ©Ÿæ§‹è¾¦ç† (3)è²»ç”¨ç”±å‹å·¥è‡ªä»˜ (4)åˆ†ç´šç®¡ç†",3`;

        let appData = [];
        let quizState = {
            currentPool: [],
            currentIndex: 0,
            answers: [], // { question, userChoice, isCorrect }
            score: 0
        };

        // --- Robust CSV Parsing Logic (State Machine) ---
        // Handles newlines inside quotes correctly
        function parseCSV(text) {
            const rows = [];
            let currentRow = [];
            let currentCell = '';
            let inQuote = false;
            
            // Normalize newlines
            text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];
                
                if (char === '"') {
                    if (inQuote && nextChar === '"') {
                        // Escaped quote "" -> "
                        currentCell += '"';
                        i++; // Skip next quote
                    } else {
                        // Toggle quote state
                        inQuote = !inQuote;
                    }
                } else if (char === ',' && !inQuote) {
                    // End of cell
                    currentRow.push(currentCell.trim());
                    currentCell = '';
                } else if (char === '\n' && !inQuote) {
                    // End of row
                    currentRow.push(currentCell.trim());
                    if (currentRow.length > 0) { // Don't skip yet, check content
                        // Only add if not empty row
                        if (currentRow.some(c => c.length > 0)) rows.push(currentRow);
                    }
                    currentRow = [];
                    currentCell = '';
                } else {
                    currentCell += char;
                }
            }
            // Push last row
            if (currentCell || currentRow.length > 0) {
                currentRow.push(currentCell.trim());
                if (currentRow.some(c => c.length > 0)) rows.push(currentRow);
            }
            
            // Convert to object array (assuming header is row 0)
            const result = [];
            if(rows.length < 2) return [];

            for(let i=1; i<rows.length; i++) {
                const row = rows[i];
                // Check if row has enough columns (at least 3: id, question, options... answer)
                if(row.length >= 4) {
                     result.push({
                        id: row[0],
                        question: row[1],
                        optionsRaw: row[2], // Usually 3rd column
                        answer: row[row.length - 1] // Last column is answer
                    });
                }
            }
            return result;
        }

        // --- Keyword Categorization Logic (Analysis) ---
        function analyzeTopics(data) {
            const categories = {
                'æ³•è¦/èªå®š': ['æ³•è¦', 'è¦å‰‡', 'èªå®š', 'åŸºæº–', 'è¦ä»¶'],
                'åŒ–å­¸/æ¯’ç‰©': ['é‰›', 'æ±', 'æ°£é«”', 'ç¡«åŒ–æ°«', 'ä¸­æ¯’', 'æš´éœ²'],
                'é†«å­¸/è‡¨åºŠ': ['ä»£è¬', 'è½åŠ›', 'ç³–å°¿ç—…', 'è¡€å£“', 'ç–¾ç—…', 'ç—‡ç‹€', 'ç—…æ­·'],
                'ç®¡ç†/å¯¦å‹™': ['é…å·¥', 'å¥æª¢', 'æª¢æŸ¥', 'ç®¡ç†', 'ç®¡æ§']
            };
            
            const counts = { 'å…¶ä»–': 0 };
            for(let k in categories) counts[k] = 0;

            data.forEach(q => {
                let matched = false;
                for (let cat in categories) {
                    if (categories[cat].some(keyword => q.question.includes(keyword) || q.optionsRaw.includes(keyword))) {
                        counts[cat]++;
                        matched = true;
                        break; 
                    }
                }
                if (!matched) counts['å…¶ä»–']++;
            });

            return counts;
        }

        // --- Initialization ---
        function initApp() {
            // Load initial data
            appData = parseCSV(initialCSV);
            updateDashboard();
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const newData = parseCSV(text);
                if (newData.length > 0) {
                    appData = newData;
                    document.getElementById('upload-status').innerText = `æˆåŠŸè¼‰å…¥ ${newData.length} ç­†è³‡æ–™`;
                    document.getElementById('upload-status').className = "mt-2 text-sm text-green-600 font-bold";
                    updateDashboard();
                    
                    // If currently in bank view, refresh it
                    if(!document.getElementById('view-bank').classList.contains('hidden')){
                        renderBank();
                    }
                } else {
                    document.getElementById('upload-status').innerText = "æ ¼å¼éŒ¯èª¤æˆ–ç„¡è³‡æ–™ (è«‹ç¢ºèªç‚º CSV æ ¼å¼)";
                    document.getElementById('upload-status').className = "mt-2 text-sm text-red-600";
                }
            };
            // Try Big5 for Traditional Chinese Excel CSVs. If it looks garbled, browser often auto-detects or user can re-save as UTF8.
            reader.readAsText(file, "Big5"); 
        }

        // --- View Navigation ---
        function navTo(viewId) {
            // Hide all views
            ['dashboard', 'bank', 'quiz', 'results'].forEach(id => {
                document.getElementById(`view-${id}`).classList.add('hidden');
                document.getElementById(`view-${id}`).classList.remove('block');
            });
            // Show selected
            const target = document.getElementById(`view-${viewId}`);
            target.classList.remove('hidden');
            target.classList.add('block');
            target.classList.add('fade-in');

            // Specific View Logic
            if (viewId === 'bank') {
                document.getElementById('search-input').value = '';
                renderBank();
            }
        }

        // --- Dashboard Logic ---
        let topicChartInstance = null;

        function updateDashboard() {
            // Text Stats
            document.getElementById('total-questions-count').innerText = appData.length;
            document.getElementById('stat-total').innerText = appData.length;
            
            const totalLen = appData.reduce((acc, q) => acc + q.question.length, 0);
            document.getElementById('stat-avg-len').innerText = appData.length ? Math.round(totalLen / appData.length) : 0;

            // Chart Logic
            const topicCounts = analyzeTopics(appData);
            const ctx = document.getElementById('topicChart').getContext('2d');

            if (topicChartInstance) topicChartInstance.destroy();

            topicChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(topicCounts),
                    datasets: [{
                        data: Object.values(topicCounts),
                        backgroundColor: [
                            '#0d9488', // Teal
                            '#f59e0b', // Amber
                            '#3b82f6', // Blue
                            '#ec4899', // Pink
                            '#9ca3af'  // Gray
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });
        }

        // --- Knowledge Bank Logic (Optimized) ---
        function renderBank() {
            const container = document.getElementById('bank-list');
            const term = document.getElementById('search-input').value.toLowerCase();
            container.innerHTML = '';

            const filtered = appData.filter(q => 
                q.question.toLowerCase().includes(term) || 
                q.optionsRaw.toLowerCase().includes(term)
            );

            document.getElementById('bank-count').innerText = `é¡¯ç¤º ${filtered.length} / ${appData.length} é¡Œ`;

            if (filtered.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">æ‰¾ä¸åˆ°ç¬¦åˆçš„é¡Œç›®</div>';
                return;
            }

            // Use DocumentFragment for performance
            const fragment = document.createDocumentFragment();

            filtered.forEach(q => { 
                const el = document.createElement('div');
                el.className = 'bg-white p-4 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-shadow';
                el.innerHTML = `
                    <div class="flex justify-between mb-2">
                        <span class="font-bold text-teal-600">#${q.id}</span>
                        <span class="text-xs text-gray-400">åƒè€ƒç­”æ¡ˆ: ${q.answer}</span>
                    </div>
                    <p class="font-medium text-gray-800 mb-2">${q.question}</p>
                    <p class="text-sm text-gray-600 bg-gray-50 p-2 rounded">${q.optionsRaw}</p>
                `;
                fragment.appendChild(el);
            });
            
            container.appendChild(fragment);
        }

        // --- Quiz Logic ---
        function startQuiz() {
            // Shuffle questions
            quizState.currentPool = [...appData].sort(() => 0.5 - Math.random());
            // Limit to 20 questions max per session
            quizState.currentPool = quizState.currentPool.slice(0, 20); 
            
            quizState.currentIndex = 0;
            quizState.answers = [];
            quizState.score = 0;

            if(quizState.currentPool.length === 0) {
                alert("ç›®å‰ç„¡è€ƒé¡Œè³‡æ–™ï¼Œè«‹å…ˆä¸Šå‚³ CSV");
                return;
            }

            navTo('quiz');
            renderQuestion();
        }

        function renderQuestion() {
            const q = quizState.currentPool[quizState.currentIndex];
            
            // Progress
            const total = quizState.currentPool.length;
            const current = quizState.currentIndex + 1;
            document.getElementById('quiz-progress-text').innerText = `${current} / ${total}`;
            document.getElementById('quiz-progress-bar').style.width = `${(current/total)*100}%`;

            // Content
            document.getElementById('quiz-id').innerText = `#${q.id}`;
            document.getElementById('quiz-question').innerText = q.question;
            
            // Options Parsing
            const optionsContainer = document.getElementById('quiz-options');
            optionsContainer.innerHTML = '';
            
            // Reset feedback
            document.getElementById('quiz-feedback').classList.add('hidden');
            document.getElementById('btn-next').classList.remove('hidden');
            document.getElementById('btn-finish').classList.add('hidden');
            
            const optionRegex = /\((\d+)\)([^()]+)/g;
            let match;
            let parsedOptions = [];
            let tempStr = q.optionsRaw;
            
            while ((match = optionRegex.exec(tempStr)) !== null) {
                parsedOptions.push({ id: match[1], text: match[2].trim() });
            }

            if (parsedOptions.length < 2) {
                const textDiv = document.createElement('div');
                textDiv.className = "bg-blue-50 p-4 rounded text-gray-700 mb-4";
                textDiv.innerText = q.optionsRaw;
                optionsContainer.appendChild(textDiv);
                
                ['1', '2', '3', '4'].forEach(id => {
                    createOptionBtn(id, `é¸é … (${id})`, optionsContainer);
                });
            } else {
                parsedOptions.forEach(opt => {
                    createOptionBtn(opt.id, `(${opt.id}) ${opt.text}`, optionsContainer);
                });
            }
        }

        function createOptionBtn(id, text, container) {
            const btn = document.createElement('button');
            btn.className = "option-btn w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-teal-500 hover:bg-teal-50 font-medium text-gray-700 relative";
            btn.innerHTML = text;
            btn.onclick = () => handleAnswer(id, btn);
            btn.dataset.id = id;
            container.appendChild(btn);
        }

        function handleAnswer(selectedId, btnElement) {
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach(b => b.disabled = true);

            const q = quizState.currentPool[quizState.currentIndex];
            const correctIds = q.answer.toString().replace(/[()]/g, '').split(',').map(s => s.trim());
            
            const isCorrect = correctIds.includes(selectedId);
            
            quizState.answers.push({
                question: q,
                userChoice: selectedId,
                isCorrect: isCorrect,
                correctAnswer: q.answer
            });

            if (isCorrect) {
                btnElement.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
                quizState.score++;
                document.getElementById('feedback-content').innerHTML = `<span class="text-green-600 font-bold">âœ… ç­”å°äº†ï¼</span>`;
            } else {
                btnElement.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
                
                buttons.forEach(b => {
                    if (correctIds.includes(b.dataset.id)) {
                        b.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
                    }
                });
                
                document.getElementById('feedback-content').innerHTML = `<span class="text-red-600 font-bold">âŒ ç­”éŒ¯äº†ï¼</span> <span class="text-gray-600 text-sm ml-2">åƒè€ƒç­”æ¡ˆ: ${q.answer}</span>`;
            }

            document.getElementById('quiz-feedback').classList.remove('hidden');
            
            if (quizState.currentIndex === quizState.currentPool.length - 1) {
                document.getElementById('btn-next').classList.add('hidden');
                document.getElementById('btn-finish').classList.remove('hidden');
            }
        }

        function nextQuestion() {
            quizState.currentIndex++;
            renderQuestion();
        }

        function finishQuiz() {
            const total = quizState.currentPool.length;
            const correct = quizState.score;
            const wrong = total - correct;

            document.getElementById('result-score').innerText = `${correct} / ${total}`;
            renderResultChart(correct, wrong);

            const list = document.getElementById('wrong-answers-list');
            list.innerHTML = '';
            
            const wrongItems = quizState.answers.filter(a => !a.isCorrect);
            
            if (wrongItems.length === 0) {
                 list.innerHTML = '<div class="p-8 text-center text-green-600 font-bold text-lg">å®Œç¾è¡¨ç¾ï¼æ²’æœ‰ä»»ä½•éŒ¯èª¤ï¼ğŸŒŸ</div>';
            } else {
                wrongItems.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'p-6 hover:bg-red-50 transition-colors';
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-red-600 font-bold text-sm">éŒ¯é¡Œ #${item.question.id}</span>
                            <span class="text-gray-400 text-xs">æ‚¨çš„é¸æ“‡: (${item.userChoice})</span>
                        </div>
                        <p class="font-bold text-gray-800 mb-2">${item.question.question}</p>
                        <div class="bg-white border border-red-100 p-3 rounded text-sm text-gray-600">
                             ${item.question.optionsRaw}
                        </div>
                        <div class="mt-2 text-sm font-bold text-green-600">
                            æ­£ç¢ºç­”æ¡ˆ: ${item.correctAnswer}
                        </div>
                    `;
                    list.appendChild(div);
                });
            }

            navTo('results');
        }

        let resultChartInstance = null;

        function renderResultChart(correct, wrong) {
            const ctx = document.getElementById('resultsChart').getContext('2d');
            if (resultChartInstance) resultChartInstance.destroy();

            resultChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ç­”å°', 'ç­”éŒ¯'],
                    datasets: [{
                        label: 'é¡Œæ•¸',
                        data: [correct, wrong],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true, grid: { display: false } },
                        y: { grid: { display: false } }
                    }
                }
            });
        }

        // Start App
        window.onload = initApp;

    </script>
</body>
</html>
